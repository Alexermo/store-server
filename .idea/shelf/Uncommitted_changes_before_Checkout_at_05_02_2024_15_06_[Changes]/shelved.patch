Index: store/orders/views.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>from http import HTTPStatus\r\nfrom typing import Any\r\n\r\nimport stripe\r\nfrom django.conf import settings\r\nfrom django.http import HttpResponse, HttpResponseRedirect\r\nfrom django.urls import reverse, reverse_lazy\r\nfrom django.views.decorators.csrf import csrf_exempt\r\nfrom django.views.generic import CreateView, TemplateView\r\n\r\n\r\nfrom products.models import Basket\r\nfrom orders.models import Order\r\nfrom common.view import TitleMixin\r\n\r\nfrom .forms import OrderForm\r\n\r\nstripe.api_key = settings.STRIPE_SECRET_KEY\r\n\r\nclass OrderSuccessView(TitleMixin, TemplateView):\r\n    template_name = 'orders/success.html'\r\n    title = 'Store - Спасибо за заказ'\r\n\r\n\r\nclass OrderCancelView(TitleMixin, TemplateView):\r\n    template_name = 'orders/cancel.html'\r\n    title = 'Checkout canceled'\r\n>>>>>>> 2ab3ba1 (tune stripe webhook)\r\n\r\n\r\nclass OrderSuccessView(TitleMixin, TemplateView):\r\n    template_name = 'orders/success.html'\r\n    title = 'Store - Спасибо за заказ'\r\n\r\n\r\nclass OrderCancelView(TitleMixin, TemplateView):\r\n    template_name = 'orders/cancel.html'\r\n    title = 'Checkout canceled'\r\n\r\n\r\n\r\nclass OrderCreateView(TemplateView):\r\n    template_name = 'orders/order-create.html'\r\n\r\n\r\n    form_class = OrderForm\r\n    success_url = reverse_lazy('orders:order_create')\r\n    title = 'Store - Order'\r\n\r\n    def post(self, request, *args, **kwargs):\r\n        super(OrderCreateView, self).post(request, *args, **kwargs)\r\n        baskets = Basket.objects.filter(user=self.request.user)\r\n\r\n        checkout_session = stripe.checkout.Session.create(\r\n            line_items=baskets.stripe_products(),\r\n            metadata={'order_id': self.object.id},\r\n            mode='payment',\r\n            success_url='{}{}'.format(\r\n                settings.DOMAIN_NAME, reverse('orders:order_success')),\r\n            cancel_url='{}{}'.format(\r\n                settings.DOMAIN_NAME, reverse('orders:order_canceled'))\r\n        )\r\n        return HttpResponseRedirect(checkout_session.url, HTTPStatus.SEE_OTHER)\r\n\r\n    def form_valid(self, form):\r\n        form.instance.initiator = self.request.user\r\n        return super(OrderCreateView, self).form_valid(form)\r\n\r\n\r\n@csrf_exempt\r\ndef stripe_webhook_view(request):\r\n    payload = request.body\r\n    sig_header = request.META['HTTP_STRIPE_SIGNATURE']\r\n    event = None\r\n\r\n    try:\r\n        event = stripe.Webhook.construct_event(\r\n            payload, sig_header, settings.STRIPE_WEBHOOK_SECRET)\r\n    except ValueError as e:\r\n        # Invalid payload\r\n        return HttpResponse(status=400)\r\n    except stripe.error.SignatureVerificationError as e:\r\n        # Invalid signature\r\n        return HttpResponse(status=400)\r\n\r\n  # Handle the checkout.session.completed event\r\n    if event['type'] == 'checkout.session.completed':\r\n        # Retrieve the session. If you require line items in the response, you may include them by expanding line_items.\r\n        session = stripe.checkout.Session.retrieve(\r\n            event['data']['object']['id'],\r\n            expand=['line_items'],\r\n        )\r\n\r\n    line_items = session\r\n    # Fulfill the purchase...\r\n    fulfill_order(session)\r\n\r\n  # Passed signature verification\r\n    return HttpResponse(status=200)\r\n\r\n\r\ndef fulfill_order(session):\r\n    order_id = int(session.metadata.order_id)\r\n    order = Order.objects.get(id=order_id)\r\n    order.update_after_payment()\r\n\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/store/orders/views.py b/store/orders/views.py
--- a/store/orders/views.py	(revision 29ae282635fdb6411bab9fd466e5ba867cfac1ae)
+++ b/store/orders/views.py	(date 1707134685579)
@@ -25,7 +25,6 @@
 class OrderCancelView(TitleMixin, TemplateView):
     template_name = 'orders/cancel.html'
     title = 'Checkout canceled'
->>>>>>> 2ab3ba1 (tune stripe webhook)
 
 
 class OrderSuccessView(TitleMixin, TemplateView):
